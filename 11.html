<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="youtube-api-key" content="AIzaSyCeWhGZfLzjWrhQ8-nWp5exmyO7sZXdE1g" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>New Tab</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-1: #0b1020;
      --muted: #9aa8c7;
      --accent: #6ad0ff;
      --ui-radius: 28px;
      --tab-height: 78px;
    }
    
    html,body{
      height:100%;
      margin:0;
      font-family:Inter,system-ui;
      background:var(--bg-1);
      color:#e9f2ff;
      overflow-x:hidden;
    }
    
    #bg{
      position:fixed;
      inset:0;
      z-index:0;
      will-change: auto;
    }
    
    .container{
      position:relative;
      z-index:3;
      max-width:980px;
      margin:28px auto;
      padding:24px;
      display:flex;
      flex-direction:column;
      gap:20px;
      padding-bottom:120px;
    }

    .card{
      background:rgba(255,255,255,0.02);
      border-radius:var(--ui-radius);
      backdrop-filter:blur(8px);
      box-shadow:0 8px 24px rgba(2,8,20,.6);
      padding:18px;
      animation: fadeInUp 0.8s ease-out;
    }

    .rgb-anim {
      position: relative;
      border-radius: 20px;
      padding: 3px;
      background: linear-gradient(135deg, #00f0ff, #9b6bff, #ff4fd8, #00f0ff);
      background-size: 300% 300%;
      animation: gradientShift 8s ease infinite;
      will-change: background-position;
    }
    
    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
 
    /* --- ENHANCEMENT: Advanced App Animations --- */
    .apps-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 20px;
        padding: 10px;
        perspective: 1000px; /* Crucial for 3D effect */
        transition: transform 0.3s ease-out; /* For parallax effect */
    }

    .app-link {
        background: linear-gradient(145deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
        border-radius: 24px;
        padding: 16px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        text-decoration: none;
        color: #e9f2ff;
        font-size: 13px;
        font-weight: 500;
        gap: 12px;
        aspect-ratio: 1/1;
        transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.3s ease;
        transform-style: preserve-3d;
        will-change: transform;
        position: relative;
        border: 1px solid rgba(255,255,255,0.1);
    }
    .app-link:hover {
        transform: translateZ(40px) scale(1.05);
        box-shadow: 0 30px 60px rgba(0,0,0,0.5);
        background: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
    }
    .app-icon {
        width: 48px;
        height: 48px;
        transition: transform 0.3s ease;
        object-fit: contain;
    }
    .app-link:hover .app-icon {
        transform: translateZ(20px);
    }
    .app-name {
        transform: translateZ(10px);
    }
    .app-link.stagger-in {
        animation: scaleTwistIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) both;
    }
    @keyframes scaleTwistIn {
        from {
            opacity: 0;
            transform: scale(0.6) rotateY(-45deg);
        }
        to {
            opacity: 1;
            transform: scale(1) rotateY(0);
        }
    }

    /* Additional Animations */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideInLeft {
      from {
        opacity: 0;
        transform: translateX(-30px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(30px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes scaleIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }

    @keyframes bounce {
      0%, 20%, 53%, 80%, 100% {
        animation-timing-function: cubic-bezier(0.215, 0.61, 0.355, 1);
        transform: translateY(0);
      }
      40%, 43% {
        animation-timing-function: cubic-bezier(0.755, 0.05, 0.855, 0.06);
        transform: translateY(-30px);
      }
      70% {
        animation-timing-function: cubic-bezier(0.755, 0.05, 0.855, 0.06);
        transform: translateY(-15px);
      }
      90% {
        transform: translateY(-4px);
      }
    }

    @keyframes shimmer {
      0% {
        background-position: -200px 0;
      }
      100% {
        background-position: calc(200px + 100%) 0;
      }
    }

    @keyframes glow {
      from {
        box-shadow: 0 0 20px rgba(106, 208, 255, 0.4);
      }
      to {
        box-shadow: 0 0 30px rgba(106, 208, 255, 0.8), 0 0 40px rgba(106, 208, 255, 0.6);
      }
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Enhanced Search Bar Styles */
    .search-bar {
      position: relative;
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }

    .search {
      flex: 1;
      position: relative;
    }

    .search input {
      width: 100%;
      padding: 16px 20px;
      background: rgba(255,255,255,0.08);
      border: 2px solid transparent;
      border-radius: 16px;
      color: #fff;
      font-size: 15px;
      font-weight: 500;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      box-sizing: border-box;
    }

    .search input:focus {
      outline: none;
      border-color: var(--accent);
      background: rgba(255,255,255,0.12);
      box-shadow: 0 8px 32px rgba(106,208,255,0.2);
      transform: translateY(-2px);
    }

    .search input::placeholder {
      color: rgba(255,255,255,0.5);
      font-weight: 400;
    }

    .btn {
      padding: 16px 24px;
      background: linear-gradient(135deg, var(--accent), #33c3ff);
      border: none;
      border-radius: 16px;
      color: #05202a;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 20px rgba(106,208,255,0.3);
      min-width: 120px;
    }

    .btn:hover {
      background: linear-gradient(135deg, #33c3ff, var(--accent));
      transform: translateY(-4px);
      box-shadow: 0 8px 32px rgba(106,208,255,0.4);
      animation: glow 0.5s ease-out;
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn.secondary {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: #fff;
      margin-left: 8px;
    }

    .btn.secondary:hover {
      background: rgba(255,255,255,0.15);
      border: 1px solid rgba(255,255,255,0.3);
    }

    /* Engine Selector */
    .engines{
      display:flex;
      gap:10px;
      margin-top:10px;
      flex-wrap:wrap;
    }
    
    .engine {
      flex:1;
      min-width:120px;
      background:rgba(255,255,255,0.05);
      border-radius:14px;
      padding:10px;
      display:flex;
      align-items:center;
      gap:10px;
      justify-content:center;
      cursor:pointer;
      transition:transform .25s ease, box-shadow .3s ease;
      will-change: transform;
      animation: slideInLeft 0.4s ease-out;
    }
    
    .engine:hover {
      transform:translateY(-6px) scale(1.05);
      box-shadow:0 12px 24px rgba(0,200,255,.4);
    }
    
    .engine:active {
      transform:scale(0.92);
    }
    
    .engine.active {
      background:linear-gradient(135deg,#9ff2ff,#55d3ff);
      color:#05202a;
      font-weight:700;
    }
    
    .engine svg{
      width:22px;
      height:22px;
      flex-shrink:0;
    }

    /* Quick Links */
    .tiles{
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 11px;
      margin-top: 10px;
      width: 100%;
    }
    
    .add-tile {
      min-width:150px;
      background:rgba(255,255,255,0.05);
      border-radius:14px;
      padding:12px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition:transform .25s ease, box-shadow .3s ease;
      border:2px dashed rgba(255,255,255,0.2);
      color:var(--muted);
      will-change: transform;
      animation: slideInRight 0.5s ease-out;
    }
    
    .add-tile:hover {
      transform:translateY(-6px) scale(1.05);
      box-shadow:0 12px 24px rgba(0,200,255,.3);
      border-color:var(--accent);
      color:#fff;
      animation: pulse 0.6s ease-in-out;
    }
    
    .add-tile svg {
      width:24px;
      height:24px;
      flex-shrink:0;
    }
   
    /* Tile Ring for Quick Links */
    .tile-ring {
      border-radius:16px;
      padding:3px;
      background: linear-gradient(135deg, #00f0ff, #9b6bff, #ff4fd8, #00f0ff);
      background-size: 300% 300%;
      animation: gradientShift 8s ease infinite;
      will-change: background-position;
      text-decoration: none;
      position: relative;
    }
    
    .tile {
      min-width:150px;
      background:rgba(255,255,255,0.05);
      border-radius:14px;
      padding:12px;
      display:flex;
      gap:10px;
      align-items:center;
      transition:transform .25s ease, box-shadow .3s ease;
      transform-style:preserve-3d;
      will-change: transform;
      animation: scaleIn 0.6s ease-out;
    }
    
    .tile:hover{
      transform:translateY(-10px) rotateX(6deg) rotateY(-6deg) scale(1.05);
      box-shadow:0 20px 40px rgba(0,200,255,.35);
    }
    
    .tile:active{
      transform:scale(0.92);
    }
    
    .tile .meta{
      display:flex;
      flex-direction:column;
    }
    
    .tile .meta .name{
      font-weight:700;
      color: inherit;
    }
    
    .tile .meta .desc{
      font-size:12px;
      color:var(--muted);
    }

    .delete-btn {
      position:absolute;
      top:8px;
      right:8px;
      background:rgba(255,59,48,0.8);
      border:none;
      border-radius:50%;
      width:24px;
      height:24px;
      cursor:pointer;
      display:none;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-size:12px;
      transition:transform .2s;
    }
    
    .tile-ring:hover .delete-btn {
      display:flex;
    }
    
    .delete-btn:hover {
      transform:scale(1.1);
      background:rgba(255,59,48,1);
    }

    /* Playlist Styles */
    .playlist-search {
      margin-bottom: 24px;
    }

    .playlist-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }

    #playlistsGrid, #searchResultsContainer {
        max-height: 60vh;
        overflow-y: auto;
        padding-right: 8px;
    }

   /* Global Neon Blue Scrollbar */
*::-webkit-scrollbar {
  width: 10px;
}

*::-webkit-scrollbar-track {
  background: rgba(255,255,255,0.05);
  border-radius: 10px;
}

*::-webkit-scrollbar-thumb {
  background: linear-gradient(180deg, #00c6ff, #0072ff);
  border-radius: 10px;
}

*::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(180deg, #33d1ff, #0094ff);
}



    #playlistsGrid::-webkit-scrollbar-track, #searchResultsContainer::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.05);
      border-radius: 10px;
    }

    #playlistsGrid::-webkit-scrollbar-thumb, #searchResultsContainer::-webkit-scrollbar-thumb {
      background: rgba(106,208,255,0.3);
      border-radius: 10px;
    }

    #playlistsGrid::-webkit-scrollbar-thumb:hover, #searchResultsContainer::-webkit-scrollbar-thumb:hover {
      background: rgba(106,208,255,0.5);
    }

    .playlist-card {
      background: rgba(255,255,255,0.05);
      border-radius: 16px;
      padding: 16px;
      transition: transform .25s ease, box-shadow .3s ease;
      will-change: transform;
      cursor: pointer;
      position: relative;
    }

    .playlist-card:hover {
      transform: translateY(-6px) scale(1.02);
      box-shadow: 0 16px 32px rgba(106,208,255,.3);
    }

    .playlist-thumbnail {
      width: 100%;
      height: 120px;
      object-fit: cover;
      border-radius: 12px;
      background: linear-gradient(45deg, #6c5ce7, #a29bfe, #74b9ff);
      margin-bottom: 12px;
    }

    .playlist-title {
      font-size: 16px;
      font-weight: 700;
      color: #fff;
      margin-bottom: 8px;
      line-height: 1.3;
    }

    .playlist-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .playlist-stats {
      font-size: 12px;
      color: var(--muted);
    }

    .playlist-type-badge {
      background: rgba(106,208,255,0.2);
      color: #6ad0ff;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .playlist-type-badge.single, .playlist-type-badge.favorites {
      background: rgba(255,193,7,0.2);
      color: #ffc107;
    }

    .playlist-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .playlist-action-btn {
      flex: 1;
      padding: 8px 12px;
      border: none;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .playlist-action-btn.primary {
      background: rgba(106,208,255,0.2);
      border: 1px solid rgba(106,208,255,0.4);
      color: #6ad0ff;
    }

    .playlist-action-btn.primary:hover {
      background: rgba(106,208,255,0.3);
      transform: translateY(-1px);
    }

    .playlist-action-btn.secondary {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: #fff;
    }

    .playlist-action-btn.secondary:hover {
      background: rgba(255,255,255,0.15);
      transform: translateY(-1px);
    }

    .playlist-action-btn.danger {
      background: rgba(255,59,48,0.2);
      border: 1px solid rgba(255,59,48,0.4);
      color: #ff3b30;
    }

    .playlist-action-btn.danger:hover {
      background: rgba(255,59,48,0.3);
      transform: translateY(-1px);
    }

/* Songs View Modal */
.songs-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.8);
  backdrop-filter: blur(10px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  animation: fadeInUp 0.3s ease-out;
}

.songs-modal.show {
  display: flex;
}

.songs-modal-content {
  background: rgba(20,25,35,0.95);
  border-radius: 20px;
  padding: 32px;
  max-width: 600px;
  width: 90%;
  max-height: 60vh;
  overflow-y: auto;
  border: 1px solid rgba(255,255,255,0.1);
  box-shadow: 0 32px 64px rgba(0,0,0,0.5);
  animation: scaleIn 0.4s ease-out;
}

.songs-modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}

.songs-modal-title {
  font-size: 24px;
  font-weight: 700;
  color: #fff;
  margin: 0;
}

.songs-modal-close {
  background: none;
  border: none;
  color: var(--muted);
  font-size: 24px;
  cursor: pointer;
  padding: 8px;
  border-radius: 8px;
  transition: all 0.25s ease;
}

.songs-modal-close:hover {
  color: #fff;
  background: rgba(255,255,255,0.1);
}

.songs-list {
  display: flex;
  flex-direction: column;
  gap: 18px;
}

.song-item {
  background: rgba(255,255,255,0.05);
  border-radius: 12px;
  padding: 16px;
  display: flex;
  align-items: center;
  gap: 16px;
  cursor: pointer;
  transition: all 0.25s ease;
  border: 1px solid transparent;
}

.song-item:hover {
  background: rgba(255,255,255,0.08);
  border-color: rgba(106,208,255,0.3);
  transform: translateY(-2px);
}

.song-thumbnail {
  width: 60px;
  height: 45px;
  border-radius: 8px;
  object-fit: cover;
  background: linear-gradient(45deg, #6c5ce7, #a29bfe);
}

.song-info {
  flex: 1;
  min-width: 0;
}

.song-title {
  font-size: 16px;
  font-weight: 600;
  color: #fff;
  margin: 0 0 4px 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.song-channel {
  font-size: 14px;
  color: var(--muted);
  margin: 0;
}

.song-duration {
  font-size: 14px;
  color: var(--muted);
  font-weight: 500;
}

.song-play-btn {
  background: rgba(106,208,255,0.2);
  border: 1px solid rgba(106,208,255,0.4);
  color: #6ad0ff;
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.25s ease;
}

.song-play-btn:hover {
  background: rgba(106,208,255,0.3);
  transform: scale(1.05);
}

/* Neon Blue Scrollbar for Songs Modal Content */
.songs-modal-content::-webkit-scrollbar {
  width: 10px;
}

.songs-modal-content::-webkit-scrollbar-track {
  background: rgba(255,255,255,0.05);
  border-radius: 10px;
}

.songs-modal-content::-webkit-scrollbar-thumb {
  background: linear-gradient(180deg, #00c6ff, #0072ff);
  border-radius: 10px;
  border: 2px solid rgba(20,25,35,0.95); /* matches modal background */
  transition: background 0.3s ease;
}

.songs-modal-content::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(180deg, #33d1ff, #0094ff);
}
    /* Enhanced Music Player Bar */
    .music-player {
        position: fixed;
        bottom: 20px;
        left: 83%;
        transform: translateX(-50%);
        width: 90%;
        max-width: 450px;
        background: rgba(10, 10, 15, 0.9);
        border-radius: 24px;
        padding: 20px;
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 16px 48px rgba(0, 0, 0, 0.7);
        display: none;
        flex-direction: column;
        gap: 12px;
        z-index: 999;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .music-player.show {
        display: flex;
        animation: slideUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    @keyframes slideUp {
        from {
            transform: translate(-50%, 120px);
            opacity: 0;
        }
        to {
            transform: translate(-50%, 0);
            opacity: 1;
        }
    }

    .current-track {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .current-thumbnail {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        background-size: cover;
        background-position: center;
        flex-shrink: 0;
        box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }

    .current-info {
        flex: 1;
        min-width: 0;
    }

    .current-info h4 {
        margin: 0 0 4px 0;
        font-size: 16px;
        font-weight: 700;
        color: #fff;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .current-info p {
        margin: 0;
        font-size: 13px;
        color: var(--muted);
    }
    
    .progress-container {
        width: 100%;
        height: 5px;
        background: rgba(255,255,255,0.1);
        border-radius: 5px;
        cursor: pointer;
        margin: 8px 0;
    }
    
    .progress-bar {
        width: 0%;
        height: 100%;
        background: var(--accent);
        border-radius: 5px;
        transition: width 0.1s linear;
    }
    
    .time-stamps {
        display: flex;
        justify-content: space-between;
        font-size: 11px;
        color: var(--muted);
        margin-top: 4px;
    }

    .player-controls {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 16px;
    }

    .control-btn {
        background: transparent;
        border: none;
        color: var(--muted);
        cursor: pointer;
        transition: all 0.25s ease;
        padding: 8px;
    }

    .control-btn:hover {
        color: #fff;
        transform: scale(1.1);
    }
    
    .control-btn.active {
        color: var(--accent);
    }

    .control-btn.primary {
        background: var(--accent);
        color: var(--bg-1);
        width: 52px;
        height: 52px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 6px 20px rgba(106, 208, 255, 0.3);
    }
    
    .control-btn.primary:hover {
        transform: scale(1.05);
        filter: brightness(1.1);
    }

    .volume-control {
        display: flex;
        align-items: center;
        gap: 8px;
        position: absolute;
        right: 20px;
        bottom: 10px;
    }
    
    .volume-control input[type="range"] {
      -webkit-appearance: none;
      width: 80px;
      height: 4px;
      background: rgba(255,255,255,0.2);
      border-radius: 4px;
      cursor: pointer;
    }
    
    .volume-control input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 14px;
      height: 14px;
      background: #fff;
      border-radius: 50%;
    }

    .close-player-btn {
        position: absolute;
        top: 12px;
        right: 12px;
        background: rgba(255,255,255,0.1);
        border-radius: 50%;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Tab content visibility */
    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Tabbar */
    .tabbar-wrap { position:fixed; left:50%; transform:translateX(-50%); bottom:10px; border-radius:44px; z-index:6; padding:2px; background: linear-gradient(135deg, #00f0ff, #9b6bff, #ff4fd8, #00f0ff); background-size: 300% 300%; animation: gradientShift 8s ease infinite; will-change: background-position; }
    .tabbar { height:var(--tab-height); min-width: 300px; background:rgba(10,10,15,.98); border-radius:40px; display:flex; align-items:center; justify-content:space-around; padding:8px 18px; border:1px solid rgba(255,255,255,.1); box-shadow:0 16px 48px rgba(0,0,0,.6), 0 0 0 1px rgba(255,255,255,.05); backdrop-filter: blur(20px); animation: fadeInUp 0.6s ease-out; animation-delay: 0.8s; animation-fill-mode: both; }
    .tab{ display:flex; flex-direction:column; align-items:center; gap:2px; color:rgba(255,255,255,0.6); font-size:12px; font-weight: 600; cursor:pointer; padding:10px 15px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); will-change: transform; border-radius: 16px; position: relative; min-width: 80px; }
    .tab:hover{ transform:translateY(-8px) scale(1.2); color:#fff; }
    .tab:active{ transform:scale(0.92); }
    .tab.active{ color:#061e25; background:linear-gradient(180deg,#9ff2ff,#55d3ff); transform:translateY(-8px) scale(1.1); border-radius: 12px; }

    /* Popup Modal */
    .modal-overlay{
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.6);
      backdrop-filter:blur(8px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:10;
    }
    
    .modal-overlay.show{
      display:flex;
    }
    
    .modal{
      background:rgba(15,20,30,0.95);
      border-radius:20px;
      padding:30px;
      max-width:400px;
      width:90%;
      border:1px solid rgba(255,255,255,0.1);
      box-shadow:0 20px 40px rgba(0,0,0,0.4);
      animation: scaleIn 0.3s ease-out;
    }
    
    .modal h3{
      margin:0 0 20px 0;
      color:#fff;
      font-size:24px;
      font-weight:700;
    }
    
    .modal-form{
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    
    .form-group{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    
    .form-group label{
      color:var(--muted);
      font-size:14px;
      font-weight:600;
    }
    
    .form-group input{
      background:rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.1);
      border-radius:12px;
      padding:12px;
      color:#fff;
      font-size:14px;
      box-sizing: border-box;
    }
    
    .form-group input:focus {
      outline:none;
      border-color:var(--accent);
      box-shadow:0 0 0 2px rgba(106,208,255,0.2);
    }
    
    .modal-buttons {
      display:flex;
      gap:12px;
      justify-content:flex-end;
      margin-top:8px;
    }
    
    .modal-btn {
      padding:10px 20px;
      border-radius:8px;
      border:none;
      cursor:pointer;
      font-weight:600;
      transition:transform .2s;
    }
    
    .modal-btn.primary {
      background:linear-gradient(180deg,var(--accent),#33c3ff);
      color:#05202a;
    }
    
    .modal-btn.secondary {
      background:rgba(255,255,255,0.1);
      color:#fff;
    }
    
    .modal-btn:hover {
      transform:scale(1.05);
    }
    
    .modal-btn:active {
      transform:scale(0.95);
    }

    /* Error and Success Messages */
    .error-message, .success-message {
      padding: 12px 16px;
      border-radius: 12px;
      margin: 12px 0;
      animation: slideInRight 0.4s ease-out;
    }

    .error-message {
      background: rgba(255,59,48,0.1);
      border: 1px solid rgba(255,59,48,0.3);
      color: #ff6b6b;
    }

    .success-message {
      background: rgba(40,167,69,0.1);
      border: 1px solid rgba(40,167,69,0.3);
      color: #51cf66;
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    /* Loading styles */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      color: var(--muted);
      background: rgba(255,255,255,0.02);
      border-radius: 16px;
      margin: 16px 0;
      border: 1px solid rgba(255,255,255,0.05);
    }

    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid rgba(255,255,255,0.1);
      border-top: 3px solid var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 12px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Empty state */
    .empty-playlists, .empty-search {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }

    .empty-playlists svg, .empty-search svg {
      width: 64px;
      height: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-playlists h3, .empty-search h3 {
      margin: 0 0 8px 0;
      color: #fff;
      font-size: 18px;
    }

    .empty-playlists p, .empty-search p {
      margin: 0;
      font-size: 14px;
      line-height: 1.5;
    }

    /* Hidden YouTube player */
    #youtube-player {
      position: absolute;
      top: -9999px;
      left: -9999px;
      width: 1px;
      height: 1px;
      opacity: 0;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .container {
        margin: 16px auto;
        padding: 16px;
      }
      
      .tiles {
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      }
      
      .tile {
        min-width: 120px;
      }
      
      .engines {
        justify-content: center;
      }
      
      .engine {
        min-width: 100px;
      }
      
      .playlist-grid {
        grid-template-columns: 1fr;
      }
      
      .music-player {
        width: calc(100% - 40px);
        left: 50%;
        transform: translateX(-50%);
        right: auto;
      }
            
      @media (max-width: 480px) {
      .search-bar {
        flex-direction: column;
        gap: 12px;
      }
      
      .btn {
        margin-left: 0;
        width: 100%;
      }
      
      .tiles {
        grid-template-columns: repeat(2, 1fr);
      }
      
      #playlistsGrid, #searchResultsContainer {
        max-height: 50vh;
      }

      .volume-control {
          display: none; /* Hide volume on smallest screens */
      }
    }
  </style>
</head>
<body>
<canvas id="bg"></canvas>

<div id="youtube-player"></div>

<div class="container">
  <!-- Search Tab -->
  <div id="search-content" class="tab-content active">
    <div class="card">
      <h2>Search the web</h2>

      <div class="search-bar">
        <form id="searchForm" class="search">
          <input name="q" id="searchInput" type="search" placeholder="Search..." autocomplete="off">
        </form>
        <button id="searchBtn" class="btn" type="button">Go</button>
      </div>

      <div class="engines">
        <!-- Bing -->
        <div class="engine active" data-engine="bing" role="button" tabindex="0">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/> 
            <path d="M5 3l4 1.5v12l6 -2.5l-2 -1l-1 -4l7 2.5v4.5l-10 5l-4 -2z" /> 
          </svg>
          Bing
        </div>

        <!-- Google -->
        <div class="engine" data-engine="google" role="button" tabindex="0">
          <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
            <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
            <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
            <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
            <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
          </svg>
          Google
        </div>

        <!-- ChatGPT -->
        <div class="engine" data-engine="chatgpt" role="button" tabindex="0">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 2406 2406" width="24" height="24">
            <path d="M1 578.4C1 259.5 259.5 1 578.4 1h1249.1c319 0 577.5 258.5 577.5 577.4V2406H578.4C259.5 2406 1 2147.5 1 1828.6V578.4z" fill="none"/>
            <path d="M1107.3 299.1c-198 0-373.9 127.3-435.2 315.3C544.8 640.6 434.9 720.2 370.5 833c-99.3 171.4-76.6 386.9 56.4 533.8-41.1 123.1-27 257.7 38.6 369.2 98.7 172 297.3 260.2 491.6 219.2 86.1 97 209.8 152.3 339.6 151.8 198 0 373.9-127.3 435.3-315.3 127.5-26.3 237.2-105.9 301-218.5 99.9-171.4 77.2-386.9-55.8-533.9v-.6c41.1-123.1 27-257.8-38.6-369.8-98.7-171.4-297.3-259.6-491-218.6-86.6-96.8-210.5-151.8-340.3-151.2zm0 117.5-.6.6c79.7 0 156.3 27.5 217.6 78.4-2.5 1.2-7.4 4.3-11 6.1L952.8 709.3c-18.4 10.4-29.4 30-29.4 51.4V1248l-155.1-89.4V755.8c-.1-187.1 151.6-338.9 339-339.2zM650 743.5v427.9c0 21.4 11 40.4 29.4 51.4l421.7 243-155.7 90L597.2 1355c-162-93.8-217.4-300.9-123.8-462.8C513.1 823.6 575.5 771 650 743.5zm807.9 106 348.8 200.8c162.5 93.7 217.6 300.6 123.8 462.8l.6.6c-39.8 68.6-102.4 121.2-176.5 148.2v-428c0-21.4-11-41-29.4-51.4l-422.3-243.7 155-89.3zM1201.7 997l177.8 102.8v205.1l-177.8 102.8-177.8-102.8v-205.1L1201.7 997zm279.5 161.6 155.1 89.4v402.2c0 187.3-152 339.2-339 339.2v-.6c-79.1 0-156.3-27.6-217-78.4 2.5-1.2 8-4.3 11-6.1l360.4-207.5c18.4-10.4 30-30 29.4-51.4l.1-486.8zM1380 1421.9v178.8l-348.8 200.8c-162.5 93.1-369.6 38-463.4-123.7h.6c-39.8-68-54-148.8-40.5-226.5 2.5 1.8 7.4 4.3 10.4 6.1l360.4 208.2c18.4 10.4 41 10.4 59.4 0l421.9-243.7z" fill="white"/>
          </svg>
          ChatGPT
        </div>

        <!-- Copilot -->
        <div class="engine" data-engine="copilot" role="button" tabindex="0">
          <svg width="24" height="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" fill="white">
            <path d="M0 32h214.6v214.6H0V32zm233.4 0H448v214.6H233.4V32zM0 265.4h214.6V480H0V265.4zm233.4 0H448V480H233.4V265.4z"/>
          </svg>
          Copilot
        </div>

        <!-- YouTube -->
        <div class="engine" data-engine="youtube" role="button" tabindex="0">
          <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
            <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
          </svg>
          YouTube
        </div>
      </div>
    </div>

    <!-- ✅ Quick Links inside Search tab -->
    <div class="card">
      <h3>Quick Links</h3>
      <div class="tiles" id="quickLinks">
        <div class="add-tile" onclick="showAddLinkModal()">
          <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          <span>Add Link</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Apps Tab -->
  <div id="apps-content" class="tab-content">
    <div class="card">
      <h2>Apps & Services</h2>
      <div class="apps-grid" id="appsGrid"></div>
    </div>
  </div>

  <!-- Playlists Tab -->
  <div id="playlists-content" class="tab-content">
    <div class="card">
      <h2>Music</h2>
      <div class="playlist-search">
        <div class="search-bar">
          <form id="playlistForm" class="search">
            <input type="text" id="playlistInput" placeholder="Enter YouTube playlist or video URL..." autocomplete="off">
          </form>
          <button id="playlistBtn" class="btn">Add URL</button>
        </div>
      </div>
      <div class="playlist-search">
        <h3>Search for a song</h3>
        <div class="search-bar">
          <form id="songSearchForm" class="search">
            <input type="text" id="songSearchInput" placeholder="Enter song name or artist..." autocomplete="off">
          </form>
          <button id="songSearchBtn" class="btn">Search</button>
        </div>
      </div>
      <div id="searchResultsContainer" class="songs-list" style="display: none;"></div>
      <h3 style="margin-top: 24px;">My Playlists</h3>
      <div class="playlist-grid" id="playlistsGrid"></div>
    </div>
  </div>
</div>


<div class="music-player" id="musicPlayer">
    <div class="current-track">
        <div class="current-thumbnail" id="currentThumbnail"></div>
        <div class="current-info">
            <h4 id="currentTitle">No song selected</h4>
            <p id="currentChannel">Select a video to play</p>
        </div>
        <button id="closePlayerBtn" class="control-btn close-player-btn" title="Close player">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
    </div>

    <div class="progress-container" id="progressContainer">
        <div class="progress-bar" id="progressBar"></div>
    </div>
    <div class="time-stamps">
        <span id="currentTime">0:00</span>
        <span id="totalDuration">0:00</span>
    </div>

    <div class="player-controls">
        <button id="shuffleBtn" class="control-btn" title="Shuffle">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/></svg>
        </button>
        <button id="prevBtn" class="control-btn" title="Previous">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
        </button>
        <button id="playPauseBtn" class="control-btn primary" title="Play/Pause">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
        </button>
        <button id="nextBtn" class="control-btn" title="Next">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M16 18h2V6h-2zm-3.5-6L4 6v12z"/></svg>
        </button>
        <button id="repeatBtn" class="control-btn" title="Repeat">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg>
        </button>
    </div>
    
    <div class="volume-control">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
        <input type="range" id="volumeSlider" min="0" max="100" value="100">
    </div>
</div>


<div class="tabbar-wrap">
  <div class="tabbar">
    <div class="tab active" data-tab="search">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
      Search
    </div>
    <div class="tab" data-tab="apps">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M4 8h4V4H4v4zm6 12h4v-4h-4v4zm-6 0h4v-4H4v4zm0-6h4v-4H4v4zm6 0h4v-4h-4v4zm6-10v4h4V4h-4zm-6 4h4V4h-4v4zm6 6h4v-4h-4v4zm0 6h4v-4h-4v4z"/></svg>
      Apps
    </div>
    <div class="tab" data-tab="playlists">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M15 6H3v2h12V6zm0 4H3v2h12v-2zM3 16h8v-2H3v2zM17 6v8.18c-.31-.11-.65-.18-1-.18-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3V8h3V6h-5z"/></svg>
      Playlists
    </div>
  </div>
</div>

<div id="addLinkModal" class="modal-overlay">
  <div class="modal">
    <h3>Add Quick Link</h3>
    <form class="modal-form" id="addLinkForm">
      <div class="form-group">
        <label for="linkName">Name</label>
        <input type="text" id="linkName" required>
      </div>
      <div class="form-group">
        <label for="linkUrl">URL</label>
        <input type="url" id="linkUrl" required>
      </div>
      <div class="form-group">
        <label for="linkDesc">Description (optional)</label>
        <input type="text" id="linkDesc">
      </div>
      <div class="modal-buttons">
        <button type="button" class="modal-btn secondary" onclick="hideAddLinkModal()">Cancel</button>
        <button type="submit" class="modal-btn primary">Add Link</button>
      </div>
    </form>
  </div>
</div>

<div id="songsModal" class="songs-modal">
  <div class="songs-modal-content">
    <div class="songs-modal-header">
      <h2 id="songsModalTitle" class="songs-modal-title">Playlist Songs</h2>
      <button class="songs-modal-close" onclick="closeSongsModal()">×</button>
    </div>
    <div id="songsModalContent" class="songs-list">
      </div>
  </div>
</div>

<script>
// YouTube player variables
let youtubePlayer;
let currentVideoId = null;
let isPlayerReady = false;
let isPlaying = false;
let currentPlaylist = [];
let originalPlaylist = [];
let currentTrackIndex = 0;
let isPlayerVisible = false;
let progressInterval;
let isShuffle = false;
let repeatMode = 'none'; // 'none', 'one', 'all'

// Helper function to get a readable title
function getReadableTitle(title) {
  if (!title) return '';
  // Decode HTML entities that might appear in titles
  const tempEl = document.createElement('textarea');
  tempEl.innerHTML = title;
  return tempEl.value.split(' ').slice(0, 8).join(' ');
}


// Global error handler
window.addEventListener('unhandledrejection', event => {
  console.error('Unhandled promise rejection:', event.reason);
  event.preventDefault();
});

// Initialize YouTube iframe API
function onYouTubeIframeAPIReady() {
  youtubePlayer = new YT.Player('youtube-player', {
    height: '1',
    width: '1',
    playerVars: {
      'autoplay': 1,
      'controls': 0,
      'disablekb': 1,
      'enablejsapi': 1,
      'fs': 0,
      'iv_load_policy': 3,
      'modestbranding': 1,
      'playsinline': 1,
      'rel': 0
    },
    events: {
      'onReady': onPlayerReady,
      'onStateChange': onPlayerStateChange,
      'onError': onPlayerError
    }
  });
}

function onPlayerReady(event) {
  isPlayerReady = true;
  console.log('YouTube player ready');
  const volumeSlider = document.getElementById('volumeSlider');
  youtubePlayer.setVolume(volumeSlider.value);
}

function onPlayerError(event) {
    console.error('YouTube Player Error:', event.data);
    showError(`Playback error (${event.data}). Skipping to next song.`);
    setTimeout(playNext, 1000); // Give a small delay before skipping
}


function onPlayerStateChange(event) {
  const playPauseBtn = document.getElementById('playPauseBtn');
  const playIcon = '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';
  const pauseIcon = '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';

  if (event.data === YT.PlayerState.PLAYING) {
    playPauseBtn.innerHTML = pauseIcon;
    isPlaying = true;
    startProgressTracker();
  } else {
    playPauseBtn.innerHTML = playIcon;
    isPlaying = false;
    stopProgressTracker();
  } 
  
  if (event.data === YT.PlayerState.ENDED) {
    handleTrackEnd();
  }
}

function handleTrackEnd() {
    switch(repeatMode) {
        case 'one':
            replayTrack();
            break;
        case 'all':
            playNext();
            break;
        case 'none':
            if (currentTrackIndex === currentPlaylist.length - 1 && !isShuffle) {
                // If it's the last song and not shuffling, stop the player
                // Optionally, you can just stop instead of closing
                // stopPlayer(); 
                closePlayer();
            } else {
                playNext();
            }
            break;
    }
}

// --- APPS TAB ---
const appsData = [
    { name: 'Google', url: 'https://google.com', icon: 'https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_%22G%22_logo.svg' },
    { name: 'YouTube', url: 'https://youtube.com', icon: 'https://upload.wikimedia.org/wikipedia/commons/0/09/YouTube_full-color_icon_%282017%29.svg' },
    { name: 'Instagram', url: 'https://instagram.com', icon: 'https://upload.wikimedia.org/wikipedia/commons/a/a5/Instagram_icon.png' },
    { name: 'TikTok', url: 'https://tiktok.com', icon: 'https://upload.wikimedia.org/wikipedia/en/a/a9/TikTok_logo.svg' },
    { name: 'Gmail', url: 'https://gmail.com', icon: 'https://upload.wikimedia.org/wikipedia/commons/7/7e/Gmail_icon_%282020%29.svg' },
    { name: 'Drive', url: 'https://drive.google.com', icon: 'https://upload.wikimedia.org/wikipedia/commons/1/12/Google_Drive_icon_%282020%29.svg' },
    { name: 'Facebook', url: 'https://facebook.com', icon: 'https://upload.wikimedia.org/wikipedia/commons/5/51/Facebook_f_logo_%282019%29.svg' },
    { name: 'X (Twitter)', url: 'https://x.com', icon: 'https://upload.wikimedia.org/wikipedia/commons/c/ce/X_logo_2023.svg' },
    { name: 'WhatsApp', url: 'https://web.whatsapp.com', icon: 'https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg' },
    { name: 'Netflix', url: 'https://netflix.com', icon: 'https://upload.wikimedia.org/wikipedia/commons/0/08/Netflix_2015_logo.svg' },
    { name: 'Spotify', url: 'https://spotify.com', icon: 'https://upload.wikimedia.org/wikipedia/commons/1/19/Spotify_logo_without_text.svg' },
    { name: 'Binance', url: 'https://binance.com', icon: 'https://upload.wikimedia.org/wikipedia/commons/e/e8/Binance_Logo.svg' },
];

function applyStaggerAnimation(parentSelector, itemSelector) {
    const items = document.querySelectorAll(`${parentSelector} ${itemSelector}`);
    items.forEach((item, index) => {
        item.style.animationDelay = `${index * 60}ms`;
    });
}

function loadApps() {
    const grid = document.getElementById('appsGrid');
    if (!grid) return;
    grid.innerHTML = appsData.map(app => `
        <a href="${app.url}" target="_blank" class="app-link stagger-in">
            <img src="${app.icon}" class="app-icon" alt="${app.name} icon" loading="lazy">
            <span class="app-name">${app.name}</span>
        </a>
    `).join('');
    applyStaggerAnimation('#appsGrid', '.app-link');
    initParallaxEffect();
}

function initParallaxEffect() {
    const grid = document.getElementById('appsGrid');
    if (!grid) return;

    grid.addEventListener('mousemove', e => {
        const { width, height, left, top } = grid.getBoundingClientRect();
        const x = e.clientX - left;
        const y = e.clientY - top;
        const rotateX = (y / height - 0.5) * -20; // Reduced intensity
        const rotateY = (x / width - 0.5) * 20;  // Reduced intensity
        grid.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
    });

    grid.addEventListener('mouseleave', () => {
        grid.style.transform = 'rotateX(0deg) rotateY(0deg)';
    });
}

// Load YouTube iframe API
function loadYouTubeAPI() {
  const tag = document.createElement('script');
  tag.src = 'https://www.youtube.com/iframe_api';
  const firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
}

// Play video function
function playVideo(videoId, title, channel = 'Unknown Artist', playlistVideos = null) {
  if (!isPlayerReady) {
    console.log('Player not ready yet');
    showError("Player is not ready. Please wait a moment.");
    return;
  }

  currentVideoId = videoId;
  
  if (playlistVideos && Array.isArray(playlistVideos)) {
    originalPlaylist = [...playlistVideos];
    currentPlaylist = isShuffle ? shuffleArray([...playlistVideos]) : [...playlistVideos];
    currentTrackIndex = currentPlaylist.findIndex(video => video.id === videoId);
    if (currentTrackIndex === -1) {
        let currentVideo = originalPlaylist.find(v => v.id === videoId);
        if (!currentVideo) currentVideo = {id: videoId, title, channelTitle: channel};
        currentPlaylist.unshift(currentVideo);
        currentTrackIndex = 0;
    }
  } else {
      currentPlaylist = [{id: videoId, title, channelTitle: channel}];
      originalPlaylist = [...currentPlaylist];
      currentTrackIndex = 0;
  }
  
  youtubePlayer.loadVideoById(videoId);
  
  const musicPlayer = document.getElementById('musicPlayer');
  musicPlayer.classList.add('show');
  isPlayerVisible = true;
  
  document.getElementById('currentTitle').textContent = getReadableTitle(title);
  document.getElementById('currentChannel').textContent = channel;
  
  const thumbnail = document.getElementById('currentThumbnail');
  thumbnail.style.backgroundImage = `url(https://img.youtube.com/vi/${videoId}/mqdefault.jpg)`;
}

// Play next track
function playNext() {
  if (currentPlaylist.length === 0) return;
  
  currentTrackIndex = (currentTrackIndex + 1) % currentPlaylist.length;
  const nextTrack = currentPlaylist[currentTrackIndex];
  
  if (nextTrack) {
    playVideo(nextTrack.id, nextTrack.title, nextTrack.channelTitle, originalPlaylist);
  }
}

// Play previous track
function playPrevious() {
  if (currentPlaylist.length === 0) return;
  
  currentTrackIndex = currentTrackIndex <= 0 ? currentPlaylist.length - 1 : currentTrackIndex - 1;
  const prevTrack = currentPlaylist[currentTrackIndex];
  
  if (prevTrack) {
    playVideo(prevTrack.id, prevTrack.title, prevTrack.channelTitle, originalPlaylist);
  }
}

// Replay current track
function replayTrack() {
  if (!isPlayerReady || !currentVideoId) return;
  youtubePlayer.seekTo(0);
  youtubePlayer.playVideo();
}

// Close player function
function closePlayer() {
  const musicPlayer = document.getElementById('musicPlayer');
  musicPlayer.classList.remove('show');
  
  if (youtubePlayer && typeof youtubePlayer.stopVideo === 'function') {
    youtubePlayer.stopVideo();
  }
  
  isPlayerVisible = false;
  isPlaying = false;
  stopProgressTracker();
  
  document.getElementById('currentTitle').textContent = 'No song selected';
  document.getElementById('currentChannel').textContent = 'Select a video to play';
  document.getElementById('currentThumbnail').style.backgroundImage = '';
  document.getElementById('progressBar').style.width = '0%';
  document.getElementById('currentTime').textContent = '0:00';
  document.getElementById('totalDuration').textContent = '0:00';

  const playBtn = document.getElementById('playPauseBtn');
  playBtn.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';
}

// Progress bar functions
function startProgressTracker() {
    if (progressInterval) clearInterval(progressInterval);
    progressInterval = setInterval(() => {
        if (isPlaying && youtubePlayer && typeof youtubePlayer.getCurrentTime === 'function') {
            const currentTime = youtubePlayer.getCurrentTime();
            const duration = youtubePlayer.getDuration();
            if (duration > 0) {
                const progress = (currentTime / duration) * 100;
                document.getElementById('progressBar').style.width = `${progress}%`;
                document.getElementById('currentTime').textContent = formatTime(currentTime);
                document.getElementById('totalDuration').textContent = formatTime(duration);
            }
        }
    }, 500);
}

function stopProgressTracker() {
    clearInterval(progressInterval);
}

function formatTime(seconds) {
    const min = Math.floor(seconds / 60);
    const sec = Math.floor(seconds % 60).toString().padStart(2, '0');
    return `${min}:${sec}`;
}

// Search functionality
function initializeSearch() {
  const searchForm = document.getElementById('searchForm');
  const searchBtn = document.getElementById('searchBtn');
  const searchInput = document.getElementById('searchInput');
  let currentEngine = 'google';

  // Engine selection
  document.querySelectorAll('.engine').forEach(engine => {
    engine.addEventListener('click', () => {
      document.querySelectorAll('.engine').forEach(e => e.classList.remove('active'));
      engine.classList.add('active');
      currentEngine = engine.dataset.engine;
    });
  });

  function performSearch() {
    const query = searchInput.value.trim();
    if (!query) return;

    let searchUrl = '';
    switch (currentEngine) {
      case 'bing':
        searchUrl = `https://www.bing.com/search?q=${encodeURIComponent(query)}`;
        break;
      case 'google':
        searchUrl = `https://www.google.com/search?q=${encodeURIComponent(query)}`;
        break;
      case 'chatgpt':
        searchUrl = `https://chatgpt.com/?q=${encodeURIComponent(query)}`;
        break;
      case 'copliot':
        searchUrl = `https://copilot.microsoft.com/?q=${encodeURIComponent(query)}`;
        break;
      case 'youtube':
        searchUrl = `https://www.youtube.com/results?search_query=${encodeURIComponent(query)}`;
        break;
    }
    
    if (searchUrl) {
      window.open(searchUrl, '_blank');
    }
  }

  searchForm.addEventListener('submit', (e) => {
    e.preventDefault();
    performSearch();
  });

  searchBtn.addEventListener('click', performSearch);
}

// Playlist functionality
function initializePlaylistManagement() {
  const playlistForm = document.getElementById('playlistForm');
  const playlistBtn = document.getElementById('playlistBtn');
  const playlistInput = document.getElementById('playlistInput');
  const songSearchForm = document.getElementById('songSearchForm');
  const songSearchBtn = document.getElementById('songSearchBtn');
  const songSearchInput = document.getElementById('songSearchInput');

  function addFromUrl() {
    const input = playlistInput.value.trim();
    if (!input) return;

    if (!isValidYouTubeURL(input)) {
      showError('Please enter a valid YouTube URL.');
      return;
    }
    
    const videoId = extractVideoId(input);
    const playlistId = extractPlaylistId(input);

    if (playlistId) {
      fetchPlaylistData(playlistId);
    } else if (videoId) {
      fetchSingleVideoData(videoId);
    } else {
      showError('Could not find a video or playlist in this URL.');
    }
  }
  
  function searchForSong() {
      const query = songSearchInput.value.trim();
      if (!query) return;
      searchSongsByName(query);
  }

  playlistForm.addEventListener('submit', (e) => { e.preventDefault(); addFromUrl(); });
  playlistBtn.addEventListener('click', addFromUrl);
  songSearchForm.addEventListener('submit', (e) => { e.preventDefault(); searchForSong(); });
  songSearchBtn.addEventListener('click', searchForSong);
}

// Enhanced YouTube URL validation
function isValidYouTubeURL(url) {
  if (!url || typeof url !== 'string') return false;
  const youtubePatterns = [
    /^(https?:\/\/)?(www\.)?youtube\.com\/.+/,
    /^(https?:\/\/)?(www\.)?youtu\.be\/.+/,
    /^[a-zA-Z0-9_-]{11}$/, 
    /^[a-zA-Z0-9_-]{24,}$/ 
  ];
  return youtubePatterns.some(pattern => pattern.test(url.trim()));
}

function extractPlaylistId(url) {
  if (!url) return null;
  const patterns = [
    /[&?]list=([a-zA-Z0-9_-]+)/,
    /playlist\?list=([a-zA-Z0-9_-]+)/,
    /\/playlist\/([a-zA-Z0-9_-]+)/,
    /^([a-zA-Z0-9_-]{24,})$/
  ];
  for (const pattern of patterns) {
    const match = url.trim().match(pattern);
    if (match && match[1] && match[1].length >= 24) {
      return match[1];
    }
  }
  return null;
}

function extractVideoId(url) {
  if (!url) return null;
  const patterns = [
    /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/,
    /\/watch\?v=([a-zA-Z0-9_-]{11})/,
    /\/embed\/([a-zA-Z0-9_-]{11})/,
    /youtu\.be\/([a-zA-Z0-9_-]{11})/,
    /^([a-zA-Z0-9_-]{11})$/
  ];
  for (const pattern of patterns) {
    const match = url.trim().match(pattern);
    if (match && match[1] && match[1].length === 11) {
      return match[1];
    }
  }
  return null;
}

async function fetchSingleVideoData(videoId) {
  try {
    showLoading('Fetching video data...', document.getElementById('playlistsGrid'));
    const apiKey = getApiKey();
    const response = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet,contentDetails&id=${videoId}&key=${apiKey}`);
    if (!response.ok) throw new Error(`API request failed: ${response.status}`);
    const data = await response.json();
    if (!data.items || data.items.length === 0) throw new Error('Video not found or is private/unavailable');
    
    const videoData = data.items[0];
    const snippet = videoData.snippet;
    const contentDetails = videoData.contentDetails;
    const duration = parseDuration(contentDetails.duration);
    
    const video = {
      id: videoId,
      title: snippet.title,
      channelTitle: snippet.channelTitle,
      thumbnail: snippet.thumbnails.medium?.url || `https://img.youtube.com/vi/${videoId}/mqdefault.jpg`,
      duration: duration
    };

    const singleSongPlaylist = {
      id: `single_${videoId}_${Date.now()}`,
      title: `Single: ${getReadableTitle(video.title)}`,
      channelTitle: video.channelTitle,
      thumbnail: video.thumbnail,
      videos: [video],
      videoCount: 1,
      type: 'single'
    };

    const savedPlaylists = JSON.parse(localStorage.getItem('userPlaylists') || '[]');
    savedPlaylists.push(singleSongPlaylist);
    localStorage.setItem('userPlaylists', JSON.stringify(savedPlaylists));
    
    hideLoading(document.getElementById('playlistsGrid'));
    showSuccess('Single song added successfully!');
    loadUserPlaylists();
    document.getElementById('playlistInput').value = '';
  } catch (error) {
    hideLoading(document.getElementById('playlistsGrid'));
    console.error('Error fetching video data:', error);
    showError('Failed to add single song: ' + error.message);
  }
}

async function fetchPlaylistData(playlistId) {
  try {
    showLoading('Fetching playlist data...', document.getElementById('playlistsGrid'));
    const apiKey = getApiKey();
    const playlistResponse = await fetch(`https://www.googleapis.com/youtube/v3/playlists?part=snippet&id=${playlistId}&key=${apiKey}`);
    if (!playlistResponse.ok) throw new Error(`Playlist API request failed: ${playlistResponse.status}`);
    const playlistData = await playlistResponse.json();
    if (!playlistData.items || playlistData.items.length === 0) throw new Error('Playlist not found or is private/unavailable');
    
    const playlist = playlistData.items[0].snippet;
    
    const itemsResponse = await fetch(`https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&playlistId=${playlistId}&maxResults=50&key=${apiKey}`);
    if (!itemsResponse.ok) throw new Error(`Playlist items API request failed: ${itemsResponse.status}`);
    const itemsData = await itemsResponse.json();
    if (!itemsData.items || itemsData.items.length === 0) throw new Error('No videos found in this playlist');
    
    const videoIds = itemsData.items.map(item => item.snippet.resourceId.videoId).join(',');
    const videosResponse = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=contentDetails&id=${videoIds}&key=${apiKey}`);
    let videoDurations = {};
    if (videosResponse.ok) {
      const videosData = await videosResponse.json();
      videosData.items?.forEach(video => {
        videoDurations[video.id] = parseDuration(video.contentDetails.duration);
      });
    }
    
    const videos = itemsData.items.map(item => {
      const snippet = item.snippet;
      const videoId = snippet.resourceId.videoId;
      return {
        id: videoId,
        title: snippet.title,
        channelTitle: snippet.videoOwnerChannelTitle || snippet.channelTitle,
        thumbnail: snippet.thumbnails.medium?.url || `https://img.youtube.com/vi/${videoId}/mqdefault.jpg`,
        duration: videoDurations[videoId] || 'Unknown'
      };
    });

    const processedPlaylist = {
      id: playlistId,
      title: getReadableTitle(playlist.title),
      channelTitle: playlist.channelTitle,
      thumbnail: videos[0]?.thumbnail || playlist.thumbnails?.medium?.url,
      videos: videos,
      videoCount: videos.length,
      type: 'playlist'
    };

    const savedPlaylists = JSON.parse(localStorage.getItem('userPlaylists') || '[]');
    const existingIndex = savedPlaylists.findIndex(p => p.id === playlistId);
    if (existingIndex !== -1) {
      savedPlaylists[existingIndex] = processedPlaylist;
      showSuccess('Playlist updated successfully!');
    } else {
      savedPlaylists.push(processedPlaylist);
      showSuccess('Playlist added successfully!');
    }
    
    localStorage.setItem('userPlaylists', JSON.stringify(savedPlaylists));
    hideLoading(document.getElementById('playlistsGrid'));
    loadUserPlaylists();
    document.getElementById('playlistInput').value = '';
  } catch (error) {
    hideLoading(document.getElementById('playlistsGrid'));
    console.error('Error fetching playlist data:', error);
    showError('Failed to fetch playlist: ' + error.message);
  }
}

// UI helper functions
function showError(message) {
  const container = document.getElementById('playlists-content').querySelector('.card');
  const errorDiv = document.createElement('div');
  errorDiv.className = 'error-message';
  errorDiv.textContent = message;
  container.insertBefore(errorDiv, container.firstChild);
  setTimeout(() => errorDiv.remove(), 5000);
}

function showSuccess(message) {
  const container = document.getElementById('playlists-content').querySelector('.card');
  const successDiv = document.createElement('div');
  successDiv.className = 'success-message';
  successDiv.textContent = message;
  container.insertBefore(successDiv, container.firstChild);
  setTimeout(() => successDiv.remove(), 3000);
}

function showLoading(message, container) {
  hideLoading(container); // Remove any existing loaders
  const loadingDiv = document.createElement('div');
  loadingDiv.className = 'loading';
  loadingDiv.innerHTML = `<div class="spinner"></div><span>${message}</span>`;
  container.insertBefore(loadingDiv, container.firstChild);
}

function hideLoading(container) {
  const loadingDiv = container.querySelector('.loading');
  if (loadingDiv) loadingDiv.remove();
}

// Load saved playlists
function loadUserPlaylists() {
  const container = document.getElementById('playlistsGrid');
  const savedPlaylists = JSON.parse(localStorage.getItem('userPlaylists') || '[]');
  
  if (savedPlaylists.length === 0) {
    container.innerHTML = `
      <div class="empty-playlists">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
        <h3>No playlists yet</h3>
        <p>Add a playlist from a URL or search for songs to create a 'Favorites' list.</p>
      </div>`;
    return;
  }
  
  container.innerHTML = savedPlaylists.map((playlist, index) => 
    createPlaylistCard(playlist, index)
  ).join('');
}

function createPlaylistCard(playlist, index) {
  const thumbnail = playlist.thumbnail || 'https://placehold.co/280x120/6c5ce7/a29bfe?text=No+Image';
  let badgeClass = '';
  let badgeText = 'Playlist';
  if (playlist.type === 'single') {
      badgeClass = 'single';
      badgeText = 'Single';
  } else if (playlist.type === 'favorites') {
      badgeClass = 'favorites';
      badgeText = 'Favorites';
  }
  
  return `
    <div class="playlist-card">
      <img src="${thumbnail}" alt="${playlist.title}" class="playlist-thumbnail" onerror="this.src='https://placehold.co/280x120/6c5ce7/a29bfe?text=Error'">
      <div class="playlist-title">${getReadableTitle(playlist.title)}</div>
      <div class="playlist-meta">
        <div class="playlist-stats">${playlist.videoCount || 0} songs</div>
        <div class="playlist-type-badge ${badgeClass}">${badgeText}</div>
      </div>
      <div class="playlist-actions">
        <button class="playlist-action-btn primary" onclick="playPlaylist(${index})">Play All</button>
        <button class="playlist-action-btn secondary" onclick="viewPlaylistSongs(${index})">View Songs</button>
        <button class="playlist-action-btn danger" onclick="deletePlaylist(${index})">Delete</button>
      </div>
    </div>`;
}

// Playlist actions
function playPlaylist(index) {
  const savedPlaylists = JSON.parse(localStorage.getItem('userPlaylists') || '[]');
  const playlist = savedPlaylists[index];
  
  if (playlist && playlist.videos && playlist.videos.length > 0) {
    const firstVideo = playlist.videos[0];
    playVideo(firstVideo.id, firstVideo.title, firstVideo.channelTitle, playlist.videos);
  } else {
    showError('No songs found in this playlist');
  }
}

function deletePlaylist(index) {
  const savedPlaylists = JSON.parse(localStorage.getItem('userPlaylists') || '[]');
  if (confirm('Are you sure you want to delete this playlist?')) {
    savedPlaylists.splice(index, 1);
    localStorage.setItem('userPlaylists', JSON.stringify(savedPlaylists));
    loadUserPlaylists();
    showSuccess('Playlist deleted successfully!');
  }
}

// Quick Links functionality
function loadQuickLinks() {
  const quickLinksContainer = document.getElementById('quickLinks');
  if (!quickLinksContainer) return;
  const addTile = quickLinksContainer.querySelector('.add-tile');
  const links = JSON.parse(localStorage.getItem('quickLinks') || '[]');
  
  quickLinksContainer.innerHTML = ''; // Clear previous links
  quickLinksContainer.appendChild(addTile); // Re-add the "Add" button
  
  links.forEach((link, index) => {
    const tileRing = createQuickLinkTile(link, index);
    addTile.insertAdjacentElement('beforebegin', tileRing); // Add links before the button
  });
}


function createQuickLinkTile(link, index) {
  const tileRing = document.createElement('a');
  tileRing.href = link.url;
  tileRing.target = '_blank';
  tileRing.className = 'tile-ring';
  
  tileRing.innerHTML = `
    <div class="tile">
      <div class="meta">
        <div class="name">${link.name}</div>
        <div class="desc">${link.description || 'Quick link'}</div>
      </div>
    </div>
    <button class="delete-btn" onclick="event.preventDefault(); deleteQuickLink(${index})">×</button>`;
  return tileRing;
}

function showAddLinkModal() {
  document.getElementById('addLinkModal').classList.add('show');
}

function hideAddLinkModal() {
  document.getElementById('addLinkModal').classList.remove('show');
  document.getElementById('addLinkForm').reset();
}

function deleteQuickLink(index) {
  const links = JSON.parse(localStorage.getItem('quickLinks') || '[]');
  links.splice(index, 1);
  localStorage.setItem('quickLinks', JSON.stringify(links));
  loadQuickLinks();
}

function shuffleArray(array) {
    let currentIndex = array.length, randomIndex;
    while (currentIndex !== 0) {
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex--;
        [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
    }
    return array;
}


// Song Search by Name
async function searchSongsByName(query) {
    const container = document.getElementById('searchResultsContainer');
    container.style.display = 'block';
    showLoading(`Searching for "${query}"...`, container);

    try {
        const apiKey = getApiKey();
        const response = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query)}&type=video&videoCategoryId=10&maxResults=10&key=${apiKey}`); // Added videoCategoryId for music
        if (!response.ok) throw new Error(`Youtube failed: ${response.status}`);
        const data = await response.json();
        
        hideLoading(container);
        
        if (!data.items || data.items.length === 0) {
            container.innerHTML = `<div class="empty-search"><p>No results found for "${query}"</p></div>`;
            return;
        }

        const videos = data.items.map(item => ({
            id: item.id.videoId,
            title: item.snippet.title,
            channelTitle: item.snippet.channelTitle,
            thumbnail: item.snippet.thumbnails.medium.url
        }));

        displaySearchResults(videos);

    } catch (error) {
        hideLoading(container);
        console.error("Error searching songs:", error);
        showError(error.message);
    }
}

function displaySearchResults(videos) {
    const container = document.getElementById('searchResultsContainer');
    const resultsHTML = videos.map(video => {
        const videoDataString = JSON.stringify(video).replace(/'/g, "&apos;");
        return `
            <div class="song-item">
                <img src="${video.thumbnail}" alt="${video.title}" class="song-thumbnail" onerror="this.src='https://placehold.co/60x45/6c5ce7/a29bfe?text=Error'">
                <div class="song-info">
                    <div class="song-title">${getReadableTitle(video.title)}</div>
                    <div class="song-channel">${video.channelTitle}</div>
                </div>
                <button class="song-play-btn" onclick="playVideo('${video.id}', '${video.title.replace(/'/g, "\\'")}', '${video.channelTitle.replace(/'/g, "\\'")}')">Play</button>
                <button class="song-play-btn secondary" onclick='addSearchedSongToPlaylist(${videoDataString})'>Add to Fav</button>
            </div>
        `;
    }).join('');
    container.innerHTML = `<h3>Search Results</h3>${resultsHTML}`;
}

function addSearchedSongToPlaylist(videoData) {
    const playlists = JSON.parse(localStorage.getItem('userPlaylists') || '[]');
    let favPlaylist = playlists.find(p => p.id === 'favorites');

    if (!favPlaylist) {
        favPlaylist = {
            id: 'favorites',
            title: 'My Favorites',
            channelTitle: 'You',
            thumbnail: videoData.thumbnail,
            videos: [],
            videoCount: 0,
            type: 'favorites'
        };
        playlists.push(favPlaylist);
    }
    
    // Check if song already exists
    if (favPlaylist.videos.some(v => v.id === videoData.id)) {
        showSuccess('Song is already in your Favorites!');
        return;
    }

    favPlaylist.videos.push(videoData);
    favPlaylist.videoCount = favPlaylist.videos.length;
    // Update thumbnail to the latest added song
    favPlaylist.thumbnail = videoData.thumbnail;

    localStorage.setItem('userPlaylists', JSON.stringify(playlists));
    showSuccess(`'${getReadableTitle(videoData.title)}' added to Favorites!`);
    loadUserPlaylists();
}


// Initialize everything when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
  loadYouTubeAPI();
  initializeSearch();
  initializePlaylistManagement();
  loadApps();
  loadQuickLinks();
  loadUserPlaylists();
  initBackgroundAnimation();
  
  // Player controls
  document.getElementById('playPauseBtn').addEventListener('click', () => {
    if (!isPlayerReady || !currentVideoId) return;
    isPlaying ? youtubePlayer.pauseVideo() : youtubePlayer.playVideo();
  });
  document.getElementById('prevBtn').addEventListener('click', playPrevious);
  document.getElementById('nextBtn').addEventListener('click', playNext);
  document.getElementById('closePlayerBtn').addEventListener('click', closePlayer);

  document.getElementById('shuffleBtn').addEventListener('click', (e) => {
      isShuffle = !isShuffle;
      e.currentTarget.classList.toggle('active', isShuffle);
      if (isPlaying) {
          // Re-shuffle the current playlist but keep the currently playing song at the top
          const currentSong = currentPlaylist[currentTrackIndex];
          const otherSongs = originalPlaylist.filter(v => v.id !== currentSong.id);
          currentPlaylist = [currentSong, ...shuffleArray(otherSongs)];
          currentTrackIndex = 0; // Reset index to the current song
      }
      showSuccess(`Shuffle is now ${isShuffle ? 'ON' : 'OFF'}`);
  });

  document.getElementById('repeatBtn').addEventListener('click', (e) => {
      const btn = e.currentTarget;
      if (repeatMode === 'none') {
          repeatMode = 'all';
          btn.classList.add('active');
          btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg>'; // Repeat all icon
          btn.title = 'Repeat All';
          showSuccess('Repeat All enabled.');
      } else if (repeatMode === 'all') {
          repeatMode = 'one';
          btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h10v-4h2v6H5v-2H3v4h14v-3l4 4-4 4v-3zM17 13h-2v-2h2v2z"/></svg>'; // Repeat one icon (conceptual)
          btn.title = 'Repeat One';
          showSuccess('Repeat One enabled.');
      } else {
          repeatMode = 'none';
          btn.classList.remove('active');
          btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg>'; // Repeat off icon
          btn.title = 'Repeat Off';
          showSuccess('Repeat disabled.');
      }
  });


  document.getElementById('volumeSlider').addEventListener('input', (e) => {
      if(isPlayerReady) youtubePlayer.setVolume(e.target.value);
  });
  
  document.getElementById('progressContainer').addEventListener('click', (e) => {
      if (!isPlayerReady || !currentVideoId) return;
      const bounds = e.currentTarget.getBoundingClientRect();
      const clickX = e.clientX - bounds.left;
      const width = bounds.width;
      const seekTo = (clickX / width) * youtubePlayer.getDuration();
      youtubePlayer.seekTo(seekTo);
  });

  // Tab switching
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      const targetTabId = `${tab.dataset.tab}-content`;
      const targetContent = document.getElementById(targetTabId);

      // Don't do anything if the tab is already active
      if(tab.classList.contains('active')) return;

      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      
      tab.classList.add('active');
      if (targetContent) {
          targetContent.classList.add('active');
      }
    });
  });

  // Add link form
  document.getElementById('addLinkForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const links = JSON.parse(localStorage.getItem('quickLinks') || '[]');
    links.push({ 
        name: document.getElementById('linkName').value, 
        url: document.getElementById('linkUrl').value, 
        description: document.getElementById('linkDesc').value 
    });
    localStorage.setItem('quickLinks', JSON.stringify(links));
    hideAddLinkModal();
    loadQuickLinks();
  });

  // Modal closing
  document.getElementById('addLinkModal').addEventListener('click', function(e) {
    if (e.target === this) hideAddLinkModal();
  });
});

// Background animation
function initBackgroundAnimation() {
  const canvas = document.getElementById('bg');
  const ctx = canvas.getContext('2d');
  let particles = [];
  let animationFrameId = null;

  function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    initParticles();
  }

  function initParticles() {
    const colors = [180, 200, 250, 300];
    const particleCount = Math.min(40, Math.floor((window.innerWidth * window.innerHeight) / 20000));
    particles = Array.from({length: particleCount}, () => ({
      x: Math.random() * canvas.width,
      y: Math.random() * canvas.height,
      r: 30 + Math.random() * 50,
      dx: (Math.random() - 0.5) * 0.4,
      dy: (Math.random() - 0.5) * 0.4,
      h: colors[Math.floor(Math.random() * colors.length)]
    }));
  }

  function animate() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    particles.forEach(p => {
      p.x += p.dx;
      p.y += p.dy;
      const gradient = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.r);
      gradient.addColorStop(0, `hsla(${p.h},100%,60%,.25)`);
      gradient.addColorStop(1, 'transparent');
      ctx.fillStyle = gradient;
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
      ctx.fill();
      if (p.x < -p.r) p.x = canvas.width + p.r;
      if (p.x > canvas.width + p.r) p.x = -p.r;
      if (p.y < -p.r) p.y = canvas.height + p.r;
      if (p.y > canvas.height + p.r) p.y = -p.r;
    });
    animationFrameId = requestAnimationFrame(animate);
  }

  resizeCanvas();
  animate();
  window.addEventListener('resize', resizeCanvas);
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      if (animationFrameId) cancelAnimationFrame(animationFrameId);
      animationFrameId = null;
    } else if (!animationFrameId) {
      animate();
    }
  });
}

// Songs Modal
function viewPlaylistSongs(index) {
  const savedPlaylists = JSON.parse(localStorage.getItem('userPlaylists') || '[]');
  const playlist = savedPlaylists[index];
  if (!playlist || !playlist.videos || playlist.videos.length === 0) {
    showError('No songs found in this playlist');
    return;
  }
  
  document.getElementById('songsModalTitle').textContent = playlist.title || 'Playlist Songs';
  const songsListContainer = document.getElementById('songsModalContent');
  
  const songsHTML = playlist.videos.map((video, videoIndex) => {
    const duration = video.duration || 'Unknown';
    const thumbnail = video.thumbnail || `https://img.youtube.com/vi/${video.id}/mqdefault.jpg`;
    return `
      <div class="song-item" onclick="playSongFromModal('${video.id}', '${video.title.replace(/'/g, "\\'")}', '${(video.channelTitle || 'Unknown').replace(/'/g, "\\'")}', ${index})">
        <img src="${thumbnail}" alt="${video.title}" class="song-thumbnail" onerror="this.src='https://placehold.co/60x45/6c5ce7/a29bfe?text=Error'">
        <div class="song-info">
          <div class="song-title">${getReadableTitle(video.title)}</div>
          <div class="song-channel">${video.channelTitle || 'Unknown Channel'}</div>
        </div>
        <div class="song-duration">${duration}</div>
        <button class="song-play-btn" onclick="event.stopPropagation(); playSongFromModal('${video.id}', '${video.title.replace(/'/g, "\\'")}', '${(video.channelTitle || 'Unknown').replace(/'/g, "\\'")}', ${index})">Play</button>
      </div>`;
  }).join('');
  
  songsListContainer.innerHTML = songsHTML;
  document.getElementById('songsModal').classList.add('show');
  document.body.style.overflow = 'hidden';
}

function closeSongsModal() {
  document.getElementById('songsModal').classList.remove('show');
  document.body.style.overflow = 'auto';
}

function playSongFromModal(videoId, title, channelTitle, playlistIndex) {
  const savedPlaylists = JSON.parse(localStorage.getItem('userPlaylists') || '[]');
  const playlist = savedPlaylists[playlistIndex];
  if (playlist && playlist.videos) {
    playVideo(videoId, title, channelTitle, playlist.videos);
    closeSongsModal();
  }
}

document.addEventListener('click', e => {
  if (e.target.id === 'songsModal') closeSongsModal();
});
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
      if (document.getElementById('songsModal').classList.contains('show')) {
          closeSongsModal();
      } else if (document.getElementById('addLinkModal').classList.contains('show')) {
          hideAddLinkModal();
      }
  }
});


// YouTube API Helpers
function getApiKey() {
  const apiKeyMeta = document.querySelector('meta[name="youtube-api-key"]');
  if (apiKeyMeta && apiKeyMeta.content) return apiKeyMeta.content;
  throw new Error('YouTube API key not available.');
}

function parseDuration(duration) {
  if (!duration) return 'Unknown';
  const match = duration.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
  if (!match) return 'Unknown';
  const hours = parseInt(match[1]) || 0;
  const minutes = parseInt(match[2]) || 0;
  const seconds = parseInt(match[3]) || 0;
  if (hours > 0) {
    return `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  }
  return `${minutes}:${seconds.toString().padStart(2, '0')}`;
}

window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;
</script>
</body>
</html>
